name: Sync Fishsp v0971-sp Branch

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # ç¬¬1æ­¥ï¼šæ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆè‡ªå·±çš„ä»“åº“ï¼‰
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          lfs: false  # å…³é”®ï¼šç¦ç”¨LFS checkouté¿å…é—®é¢˜

      # ç¬¬2æ­¥ï¼šé…ç½®Gitç¯å¢ƒ
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # å¼ºåˆ¶ä½¿ç”¨HTTPSï¼Œé¿å…SSHé—®é¢˜
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          
          # é…ç½®è®¤è¯
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GH_PAT }}@github.com" > ~/.git-credentials
          
          # LFSé…ç½®ï¼ˆä¸ºåç»­å¯èƒ½éœ€è¦åšå‡†å¤‡ï¼‰
          git lfs install --skip-smudge --force
          git config --global lfs.fetchrecentrefsdays 0
          git config --global lfs.fetchrecentremoterefs false
          
          echo "âœ… Gitç¯å¢ƒé…ç½®å®Œæˆ"

      # ç¬¬3æ­¥ï¼šæ·»åŠ æºä»“åº“å¹¶è·å–åˆ†æ”¯
      - name: Fetch source branch
        run: |
          echo "=== æ·»åŠ fishspè¿œç¨‹ä»“åº“ ==="
          git remote add fishsp https://github.com/fishsp/openpilot.git
          
          echo "=== è·å–ç›®æ ‡åˆ†æ”¯ ==="
          # åªè·å–æˆ‘ä»¬éœ€è¦çš„åˆ†æ”¯ï¼ŒåŠ é€Ÿæ“ä½œ
          git fetch --no-tags --depth=1 fishsp v0971-sp
          
          echo "=== éªŒè¯åˆ†æ”¯å­˜åœ¨ ==="
          if ! git show-ref --verify --quiet refs/remotes/fishsp/v0971-sp; then
            echo "âŒ åˆ†æ”¯ v0971-sp ä¸å­˜åœ¨äº fishsp ä»“åº“"
            exit 1
          fi
          
          echo "âœ… æºåˆ†æ”¯è·å–æˆåŠŸ"

      # ç¬¬4æ­¥ï¼šåˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°åˆ†æ”¯
      - name: Update local branch
        run: |
          echo "=== å¤„ç†æœ¬åœ°åˆ†æ”¯ v0971-sp ==="
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
          if git show-ref --verify --quiet refs/heads/v0971-sp; then
            echo "åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢å¹¶æ›´æ–°"
            git checkout v0971-sp
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯"
            git checkout -b v0971-sp
          fi
          
          # é‡ç½®åˆ°fishspçš„ç‰ˆæœ¬
          git reset --hard fishsp/v0971-sp
          
          echo "âœ… æœ¬åœ°åˆ†æ”¯æ›´æ–°å®Œæˆ"

      # ç¬¬5æ­¥ï¼šå¤„ç†LFSæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Handle LFS files
        run: |
          echo "=== æ£€æŸ¥LFSæ–‡ä»¶çŠ¶æ€ ==="
          
          if [ -f .gitattributes ] && grep -q "filter=lfs" .gitattributes; then
            echo "å‘ç°LFSé…ç½®æ–‡ä»¶"
            
            # æ˜¾ç¤ºLFSæ–‡ä»¶ä¿¡æ¯
            if command -v git-lfs >/dev/null 2>&1; then
              echo "LFSæ–‡ä»¶åˆ—è¡¨ï¼š"
              git lfs ls-files | head -5 || echo "æ— LFSæ–‡ä»¶æˆ–å‘½ä»¤å¤±è´¥"
              
              echo "LFSè·Ÿè¸ªçš„æ–‡ä»¶æ¨¡å¼ï¼š"
              grep "filter=lfs" .gitattributes | head -5 || echo "æ— LFSæ¨¡å¼"
            fi
            
            # å…³é”®å†³ç­–ï¼šå¯¹äºè·¨ä»“åº“åŒæ­¥ï¼Œæˆ‘ä»¬ä¿ç•™LFSé…ç½®ä½†ä¸å°è¯•ä¸‹è½½å®é™…æ–‡ä»¶
            echo "ä¿ç•™LFSé…ç½®æ–‡ä»¶ï¼Œå…è®¸Gitå†å²åŒ…å«LFSæŒ‡é’ˆ"
            echo "æ³¨æ„ï¼šLFSæ–‡ä»¶å°†ä½œä¸ºæŒ‡é’ˆå­˜åœ¨ï¼Œè¿™å¯¹äºä»£ç åŒæ­¥æ˜¯è¶³å¤Ÿçš„"
          else
            echo "æœªå‘ç°LFSé…ç½®"
          fi
          
          echo "âœ… LFSæ£€æŸ¥å®Œæˆ"

      # ç¬¬6æ­¥ï¼šæ¨é€åˆ°ç›®æ ‡ä»“åº“
      - name: Push to target repository
        run: |
          echo "=== é…ç½®ç›®æ ‡ä»“åº“æ¨é€ ==="
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/zhouad/openpilot.git
          
          echo "=== æ¨é€åˆ†æ”¯ ==="
          # ä½¿ç”¨forceæ¨é€ç¡®ä¿åŒæ­¥ï¼Œä½†å…ˆæ£€æŸ¥æ˜¯å¦çœŸçš„éœ€è¦æ›´æ–°
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git ls-remote origin refs/heads/v0971-sp | grep -q $(git rev-parse HEAD); then
            echo "è¿œç¨‹åˆ†æ”¯å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ¨é€"
          else
            echo "æ£€æµ‹åˆ°å˜åŒ–ï¼Œå¼€å§‹æ¨é€..."
            
            # æ¨é€ï¼ŒåŒ…å«è¯¦ç»†è¾“å‡º
            if git push -u origin v0971-sp --force --verbose; then
              echo "âœ… æ¨é€æˆåŠŸ"
            else
              echo "âŒ æ¨é€å¤±è´¥"
              exit 1
            fi
          fi

      # ç¬¬7æ­¥ï¼šéªŒè¯åŒæ­¥ç»“æœ
      - name: Verify sync result
        run: |
          echo "=== åŒæ­¥ç»“æœéªŒè¯ ==="
          
          echo "è¿œç¨‹åˆ†æ”¯çŠ¶æ€ï¼š"
          git ls-remote origin v0971-sp
          
          echo ""
          echo "æœ€æ–°æäº¤ä¿¡æ¯ï¼š"
          git log --oneline -3 v0971-sp
          
          echo ""
          echo "åˆ†æ”¯ç»Ÿè®¡ï¼š"
          echo "- æœ¬åœ°åˆ†æ”¯: $(git rev-parse v0971-sp)"
          echo "- è¿œç¨‹åˆ†æ”¯: $(git rev-parse fishsp/v0971-sp)"
          
          if [ "$(git rev-parse v0971-sp)" = "$(git rev-parse fishsp/v0971-sp)" ]; then
            echo "âœ… åŒæ­¥éªŒè¯æˆåŠŸï¼šæœ¬åœ°åˆ†æ”¯ä¸æºåˆ†æ”¯ä¸€è‡´"
          else
            echo "âš ï¸ è­¦å‘Šï¼šæœ¬åœ°åˆ†æ”¯ä¸æºåˆ†æ”¯ä¸ä¸€è‡´"
          fi
          
          echo ""
          echo "ğŸ‰ åŒæ­¥ä»»åŠ¡å®Œæˆï¼"

      # ç¬¬8æ­¥ï¼šæ¸…ç†ï¼ˆå¯é€‰ï¼‰
      - name: Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç†ä¸´æ—¶é…ç½® ==="
          rm -f ~/.git-credentials || true
          echo "æ¸…ç†å®Œæˆ"
