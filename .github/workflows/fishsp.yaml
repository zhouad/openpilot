name: Sync Fishsp Branches

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    env:
      GIT_SSH_COMMAND: "echo 'SSH disabled'; exit 1"
    steps:
      - name: Checkout openpilot repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          lfs: false  # 暂时禁用LFS checkout
          fetch-depth: 0

      - name: 配置Git（不含LFS）
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GH_PAT }}@github.com" > ~/.git-credentials
          
          echo "=== Git配置完成 ==="

      - name: 检查并同步fishsp分支
        run: |
          git remote add fishsp https://github.com/fishsp/openpilot.git
          git fetch fishsp v0971-sp --no-tags
          
          if git show-ref --verify --quiet refs/heads/v0971-sp; then
            git checkout v0971-sp
          else
            git checkout -b v0971-sp
          fi
          
          git reset --hard fishsp/v0971-sp
          echo "✅ 分支同步完成"

      - name: 推送到GitHub（安全模式）
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/zhouad/openpilot.git
          
          echo "=== 检查潜在的LFS问题 ==="
          if [ -f .gitattributes ] && grep -q "filter=lfs" .gitattributes; then
            echo "⚠️ 发现LFS配置，暂时禁用以避免推送问题"
            mv .gitattributes .gitattributes.disabled
          fi
          
          echo "=== 推送Git历史 ==="
          git push -u origin v0971-sp --force --verbose
          
          if [ -f .gitattributes.disabled ]; then
            mv .gitattributes.disabled .gitattributes
            echo "已恢复LFS配置文件"
          fi
          
          echo "✅ 推送完成"
          git ls-remote origin v0971-sp
