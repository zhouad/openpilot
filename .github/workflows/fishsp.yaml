name: Sync Fishsp Branches

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    env:
      GIT_SSH_COMMAND: "echo 'SSH disabled'; exit 1"
    steps:
      - name: Checkout openpilot repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          lfs: true
          fetch-depth: 0

      - name: 配置Git和LFS认证（纯HTTPS模式）
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 完全禁用SSH
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          
          # 设置凭据
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GH_PAT }}@github.com" > ~/.git-credentials
          
          # 强制LFS使用HTTPS
          git config --global lfs.https://github.com/zhouad/openpilot.git/info/lfs.access basic
          git config --global lfs.transfer.maxretries 1
          git config --global lfs.concurrenttransfers 1
          
          # 禁用SSH环境变量
          unset SSH_AUTH_SOCK || true
          unset SSH_AGENT_PID || true
          
          git lfs install --force
          
          echo "=== 测试HTTPS连接 ==="
          curl -s -I -H "Authorization: token ${{ secrets.GH_PAT }}" \
               "https://api.github.com/repos/zhouad/openpilot" | head -1

      - name: 检查源仓库配置
        run: |
          git remote add fishsp https://github.com/fishsp/openpilot.git
          git fetch fishsp v0971-sp --no-tags
          
          if git show fishsp/v0971-sp:.gitattributes 2>/dev/null | grep -q "filter=lfs"; then
            echo "⚠️ 源仓库使用LFS"
          else
            echo "✓ 源仓库不使用LFS"
          fi

      - name: 同步分支
        run: |
          if git show-ref --verify --quiet refs/heads/v0971-sp; then
            git checkout v0971-sp
          else
            git checkout -b v0971-sp
          fi
          
          # 如果源仓库有LFS，跳过LFS文件下载
          if git show fishsp/v0971-sp:.gitattributes 2>/dev/null | grep -q "filter=lfs"; then
            export GIT_LFS_SKIP_SMUDGE=1
          fi
          
          git reset --hard fishsp/v0971-sp
          git log --oneline -3

      - name: 推送到GitHub（纯HTTPS）
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/zhouad/openpilot.git
          
          echo "=== 推送Git历史（跳过LFS处理） ==="
          git -c lfs.smudge="cat" -c lfs.clean="cat" push -u origin v0971-sp --force
          
          echo "=== 推送完成 ==="
          git ls-remote origin v0971-sp
