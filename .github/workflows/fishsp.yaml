name: Sync Fishsp v0971-sp Branch

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          lfs: false

      - name: Configure Git and LFS
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # å¼ºåˆ¶æ‰€æœ‰Gitæ“ä½œä½¿ç”¨HTTPS
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          
          # å…³é”®ï¼šé…ç½®LFSä¹Ÿä½¿ç”¨HTTPS
          git config --global lfs.url "https://github.com/zhouad/openpilot.git/info/lfs"
          git config --global lfs.pushurl "https://github.com/zhouad/openpilot.git/info/lfs"
          
          # é…ç½®è®¤è¯
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GH_PAT }}@github.com" > ~/.git-credentials
          
          # LFSé…ç½® - å¼ºåˆ¶ä½¿ç”¨HTTPSè®¤è¯
          git lfs install --force
          git config --global lfs.transfer.maxretries 3
          
          # ç¦ç”¨SSHç›¸å…³çš„LFSé…ç½®
          git config --global lfs.ssh.detectproxy false
          
          echo "âœ… Gitå’ŒLFSç¯å¢ƒé…ç½®å®Œæˆ"

      - name: Fetch source branch
        run: |
          echo "=== æ·»åŠ fishspè¿œç¨‹ä»“åº“ ==="
          git remote add fishsp https://github.com/fishsp/openpilot.git
          
          echo "=== è·å–ç›®æ ‡åˆ†æ”¯ ==="
          git fetch --no-tags --depth=1 fishsp v0971-sp
          
          echo "=== éªŒè¯åˆ†æ”¯å­˜åœ¨ ==="
          if ! git show-ref --verify --quiet refs/remotes/fishsp/v0971-sp; then
            echo "âŒ åˆ†æ”¯ v0971-sp ä¸å­˜åœ¨äº fishsp ä»“åº“"
            exit 1
          fi
          
          echo "âœ… æºåˆ†æ”¯è·å–æˆåŠŸ"

      - name: Update local branch
        run: |
          echo "=== å¤„ç†æœ¬åœ°åˆ†æ”¯ v0971-sp ==="
          
          if git show-ref --verify --quiet refs/heads/v0971-sp; then
            echo "åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢å¹¶æ›´æ–°"
            git checkout v0971-sp
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯"
            git checkout -b v0971-sp
          fi
          
          git reset --hard fishsp/v0971-sp
          echo "âœ… æœ¬åœ°åˆ†æ”¯æ›´æ–°å®Œæˆ"

      - name: Configure target repository for push
        run: |
          echo "=== é…ç½®ç›®æ ‡ä»“åº“æ¨é€ ==="
          
          # ç¡®ä¿è¿œç¨‹URLä½¿ç”¨HTTPSå’Œtoken
          git remote set-url origin "https://x-access-token:${{ secrets.GH_PAT }}@github.com/zhouad/openpilot.git"
          
          # é‡æ–°é…ç½®LFS URLç¡®ä¿æŒ‡å‘æ­£ç¡®çš„ä»“åº“
          git config lfs.url "https://x-access-token:${{ secrets.GH_PAT }}@github.com/zhouad/openpilot.git/info/lfs"
          git config lfs.pushurl "https://x-access-token:${{ secrets.GH_PAT }}@github.com/zhouad/openpilot.git/info/lfs"
          
          # éªŒè¯é…ç½®
          echo "è¿œç¨‹URL: $(git remote get-url origin)"
          echo "LFS URL: $(git config lfs.url)"
          
          echo "âœ… æ¨é€é…ç½®å®Œæˆ"

      - name: Handle LFS files safely
        run: |
          echo "=== å®‰å…¨å¤„ç†LFSæ–‡ä»¶ ==="
          
          if [ -f .gitattributes ] && grep -q "filter=lfs" .gitattributes; then
            echo "å‘ç°LFSé…ç½®ï¼Œæ£€æŸ¥LFSæ–‡ä»¶çŠ¶æ€..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰LFSæ–‡ä»¶
            if git lfs ls-files | head -1 | grep -q .; then
              echo "å‘ç°LFSæ–‡ä»¶åˆ—è¡¨:"
              git lfs ls-files | head -3
              
              echo "å‡†å¤‡å¤„ç†LFSæ–‡ä»¶æ¨é€..."
              # å¯¹äºè·¨ä»“åº“åŒæ­¥ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¿å®ˆç­–ç•¥
              echo "æ³¨æ„: LFSæ–‡ä»¶å°†ä½œä¸ºæŒ‡é’ˆæ¨é€ï¼ˆè¿™æ˜¯æ­£å¸¸çš„è·¨ä»“åº“è¡Œä¸ºï¼‰"
            else
              echo "æœªå‘ç°å®é™…LFSæ–‡ä»¶"
            fi
          else
            echo "æœªå‘ç°LFSé…ç½®"
          fi
          
          echo "âœ… LFSå¤„ç†å®Œæˆ"

      - name: Push to target repository
        run: |
          echo "=== æ¨é€åˆ†æ”¯ ==="
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨é€
          if git ls-remote origin refs/heads/v0971-sp | grep -q $(git rev-parse HEAD); then
            echo "è¿œç¨‹åˆ†æ”¯å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ¨é€"
          else
            echo "æ£€æµ‹åˆ°å˜åŒ–ï¼Œå¼€å§‹æ¨é€..."
            
            # é¦–å…ˆå°è¯•æ¨é€Gitå†å²ï¼ˆä¸åŒ…æ‹¬LFSï¼‰
            echo "æ¨é€Gitå†å²..."
            if GIT_LFS_SKIP_PUSH=1 git push -u origin v0971-sp --force --verbose; then
              echo "âœ… Gitå†å²æ¨é€æˆåŠŸ"
              
              # å¦‚æœæœ‰LFSæ–‡ä»¶ï¼Œå°è¯•æ¨é€ï¼ˆä½†å…è®¸å¤±è´¥ï¼‰
              if [ -f .gitattributes ] && grep -q "filter=lfs" .gitattributes && git lfs ls-files | head -1 | grep -q .; then
                echo "å°è¯•æ¨é€LFSæ–‡ä»¶..."
                
                # è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶é¿å…hang
                timeout 60 git lfs push --all origin || {
                  echo "âš ï¸ LFSæ¨é€è¶…æ—¶æˆ–å¤±è´¥ï¼Œè¿™åœ¨è·¨ä»“åº“åŒæ­¥ä¸­æ˜¯æ­£å¸¸çš„"
                  echo "Gitå†å²å·²æˆåŠŸåŒæ­¥ï¼ŒLFSæ–‡ä»¶ä¿æŒä¸ºæŒ‡é’ˆçŠ¶æ€"
                }
              fi
              
            else
              echo "âŒ Gitå†å²æ¨é€å¤±è´¥"
              exit 1
            fi
          fi

      - name: Verify sync result
        run: |
          echo "=== åŒæ­¥ç»“æœéªŒè¯ ==="
          
          echo "è¿œç¨‹åˆ†æ”¯çŠ¶æ€:"
          git ls-remote origin v0971-sp
          
          echo ""
          echo "æœ€æ–°æäº¤ä¿¡æ¯:"
          git log --oneline -3 v0971-sp
          
          echo ""
          echo "åˆ†æ”¯å¯¹æ¯”:"
          echo "- æœ¬åœ°: $(git rev-parse v0971-sp)"
          echo "- æºä»“åº“: $(git rev-parse fishsp/v0971-sp)"
          
          if [ "$(git rev-parse v0971-sp)" = "$(git rev-parse fishsp/v0971-sp)" ]; then
            echo "âœ… åŒæ­¥éªŒè¯æˆåŠŸï¼šæœ¬åœ°åˆ†æ”¯ä¸æºåˆ†æ”¯ä¸€è‡´"
          else
            echo "âš ï¸ è­¦å‘Šï¼šæœ¬åœ°åˆ†æ”¯ä¸æºåˆ†æ”¯ä¸ä¸€è‡´"
          fi
          
          echo ""
          echo "ğŸ‰ åŒæ­¥ä»»åŠ¡å®Œæˆï¼"

      - name: Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç†ä¸´æ—¶é…ç½® ==="
          rm -f ~/.git-credentials || true
          echo "æ¸…ç†å®Œæˆ"
