name: Test PAT 权限

on:
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout openpilot repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: 配置Git和LFS认证
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 方法1：直接为LFS配置认证
          git config --global lfs.https://github.com/zhouad/openpilot.git/info/lfs.access basic
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GH_PAT }}@github.com" > ~/.git-credentials
          
          # 重新安装LFS
          git lfs install --force
          
          # 验证配置
          echo "=== Git认证配置 ==="
          git config --get credential.helper
          
          echo "=== LFS认证验证 ==="
          git lfs env | grep -E "(Endpoint|Access)"
          
          echo "=== 测试LFS访问 ==="
          curl -I -H "Authorization: token ${{ secrets.GH_PAT }}" \
               "https://github.com/zhouad/openpilot.git/info/lfs/objects/batch" || echo "LFS endpoint测试完成"
      
      
            
      - name: 验证PAT权限
        run: |
          # 测试基本API访问
          curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
               https://api.github.com/user | jq '.login'
          
          # 测试仓库写权限
          curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
               https://api.github.com/repos/zhouad/openpilot | jq '.permissions'
          
          # 检查账户LFS配额
          
          curl -H "Authorization: token ${{ secrets.GH_PAT }}" \
               https://api.github.com/user \
               | jq '.plan.space, .plan.collaborators'
      - name: 综合环境检查
        run: |
          echo "=== Git和LFS版本 ==="
          git --version
          git lfs version
          
          echo "=== PAT权限检查 ==="
          curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
               https://api.github.com/repos/zhouad/openpilot | jq '.permissions // "权限检查失败"'
          
          echo "=== LFS配置检查 ==="
          git lfs env
          
          echo "=== 当前LFS文件 ==="
          git lfs ls-files | head -5
          
          echo "=== 远程仓库配置 ==="
          git remote -v
          
          echo "=== 磁盘空间检查 ==="
          df -h | grep -E "(Filesystem|/dev/)"


